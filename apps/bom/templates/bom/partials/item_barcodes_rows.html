{% for item in item_list %}
{% load humanize %}
<tr data-item-id="{{ item.commodity_code }}">
    <td>
        <button class="btn btn-link" onclick="handlePlusClick(this)"
                hx-post="{% url 'add_selected_barcode_item' %}" 
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                hx-trigger="click"
                hx-target="#selectedItemsContainer"
                hx-vals='{
                    "item_commodity_code": "{{ item.commodity_code }}",
                    "item_commodity_name": "{{ item.commodity_name }}",
                    "item_manufacturer_part_nbr": "{{ item.manufacturer_part_nbr }}",
                    "item_warehouse_code": "{{ item.warehouse_code }}",
                    "item_warehouse_name": "{{ item.warehouse_name }}",
                    "item_min_reorder_lvl": "{{ item.min_reorder_lvl }}"
                }'>
            <i class="fa fa-plus"></i> <!-- Font Awesome Plus Icon -->
        </button>
        {{ item.commodity_code }}</td>
    <td>{{ item.commodity_name }}</td>
    <td>{{ item.manufacturer_part_nbr }}</td>
</tr>
{% empty %}
<tr>
    <td colspan="7" class="text-center">No items found.</td>
</tr>
{% endfor %}

<script>
    // Object to store the button states
    if (typeof buttonStates === 'undefined') {
        var buttonStates = {};
    }

    function handlePlusClick(button) {
        // Get the unique identifier for the row (e.g., commodity code)
        const rowId = button.closest("tr").dataset.itemId;

        // Find the icon element inside the button
        const icon = button.querySelector('i');

        // Check if the button is currently in the "plus" state
        if (icon.classList.contains('fa-plus')) {
            // Count the number of rows in the "minus" state
            const selectedCount = Object.values(buttonStates).filter(state => state === 'minus').length;

            // If there are already 16 selected, show an alert and prevent further selection
            if (selectedCount >= 16) {
                alert("16 is the maximum number of items you can select.");
                return; // Prevent further execution
            }

            // Change the button to the "minus" state
            icon.classList.remove('fa-plus');
            icon.classList.add('fa-minus', 'text-danger'); // Add 'text-danger' for red color
            buttonStates[rowId] = 'minus'; // Update the state
        } else {
            // Change the button back to the "plus" state
            icon.classList.remove('fa-minus', 'text-danger');
            icon.classList.add('fa-plus');
            buttonStates[rowId] = 'plus'; // Update the state
        }
    }

    // Function to restore button states after a search
    function restoreButtonStates() {
        const rows = document.querySelectorAll("#itemTableBody tr");
        rows.forEach(row => {
            const rowId = row.dataset.itemId;

            // Only update rows that exist in the buttonStates object
            if (buttonStates[rowId]) {
                const button = row.querySelector("button");
                const icon = button.querySelector('i');

                // Check the state and update the button accordingly
                if (buttonStates[rowId] === 'minus') {
                    icon.classList.remove('fa-plus');
                    icon.classList.add('fa-minus', 'text-danger');
                } else {
                    icon.classList.remove('fa-minus', 'text-danger');
                    icon.classList.add('fa-plus');
                }
            }
        });
    }

    // Call restoreButtonStates after the table is updated (e.g., after a search)
    document.addEventListener("htmx:afterSwap", function () {
        restoreButtonStates();
    });
</script>
{% extends 'base.html' %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
<script type='text/javascript'>
    var groups = {{ groups_json|safe }};
    var networklist = {{ network_json|safe }};
    var eventBus = new Vue();
</script>


<h1>New Image</h1>

<div class="container">
    <form method="POST">
        {% csrf_token %}

        <div id="div_formbody">
            {% for field in form %}
            {% if field.auto_id == 'id_admin_group' %}
                <div id="group">
                    <h6>McCommunity Admin Group:
                    <select class="form-control" name="admin_group" id="id_admin_group" v-model="selectedGroup" @change="handleGroupChange">
                        <option v-for="group in groups" :value="group.id" :key="group.id">[[group.name]] </option>
                    </select></h6>
                </div>
            {% elif field.auto_id == 'id_networks' %}
                <div id="network" v-show="visible">
                    <h6>Networks:
                    <select class="form-control" name="network" id="id_network" v-model="selectedNetwork" width="350px">
                        <option v-for="network in filteredNetworks" :value="network.id" :key="network.id">[[network.name]] </option>
                    </select></h6>
                </div>
            {% elif field.auto_id == 'id_cpu' %}
                    <div class="form-group" id="wrapper_calculator">
                        <div id="wrapper_id_cpu">
                            <div class="row">
                                <div class="col"><h6>CPU</label>{{ field }}</h6></div>
            {% elif field.auto_id == 'id_cpu_cost' %}
                            <div class="col"><h6>CPU Total</label>{{ field }}</h6></div>
                        </div>
                    </div>
            {% elif field.auto_id == 'id_memory' %}
                <div id="wrapper_id_memory">
                    <div class="row">
                        <div class="col"><h6>Memory</label>{{ field }}</h6></div>
            {% elif field.auto_id == 'id_memory_cost' %}
                    <div class="col"><h6>RAM Total</label>{{ field }}</h6></div>
                    </div>
                </div>
            {% elif field.auto_id == 'id_storage' %}
                <div id="wrapper_id_storage">
                    <div class="row">
                        <div class="col"><h6>Disk Space</label>{{ field }}</h6></div>
            {% elif field.auto_id == 'id_storage_cost' %}
                    <div class="col"><h6>Disk Space Total</label>{{ field }}</h6></div>
                    </div>
                    </div>
            {% elif field.auto_id == 'id_gpu' %}
                <div id="wrapper_id_gpu">
                    <div class="row">
                        <div class="col"><h6>GPU (optional)</label>{{ field }}</h6></div>
            {% elif field.auto_id == 'id_gpu_cost' %}
                    <div class="col"><h6>GPU Total</label>{{ field }}</h6></div>
                    </div>
                </div>
            {% elif field.auto_id == 'id_total' %}
                    <label for="id_total"><h6>Base Image Total</h6></label>
                    {{ field }}
                    </div>
            {% else %}
            <div class="form-group" id="wrapper_{{ field.auto_id }}">
                <h6>{% if field.field.required %}<span style="color:red; font-size:12px;">* </span>{% endif %}
                <label for="{{ field.label }}">{{ field.label_tag }}</label>
                {{ field }}
                </h6>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        <button id="submit_btn" type="submit" class="btn btn-primary">Submit</button>
    </form>

</div>
<script src="/static/vue-components/admin-group/admin-group.js"></script>
<script src="/static/vue-components/midesktop-networks/midesktop-networks.js"></script>

{% endblock %}

{% block js %}
<script>
    const cpu_cost = document.getElementById("id_cpu_cost");
    const memory_cost = document.getElementById("id_memory_cost");
    const storage_cost = document.getElementById("id_storage_cost");
    const gpu_cost = document.getElementById("id_gpu_cost");
    const total_cost = document.getElementById("{{ form.total.id_for_label }}");
    const network_type = document.getElementById("{{ form.network_type.id_for_label }}");
    const networks = document.getElementById("id_networks");

    const cpu_choice = document.getElementById("{{ form.cpu.id_for_label }}");
    const memory_choice = document.getElementById("{{ form.memory.id_for_label }}");
    const storage_choice = document.getElementById("{{ form.storage.id_for_label }}");
    const gpu_choice = document.getElementById("{{ form.gpu.id_for_label }}");

    const network_type_wrapper = document.getElementById("wrapper_id_network_type")
    const name_wrapper = document.getElementById("wrapper_id_name");
    const networks_wrapper = document.getElementById("wrapper_id_networks");


    window.addEventListener("load", (event) => {page_load()})
    
    function page_load(){
        read_only_initial_elements()
        //hide_initial_elements()
    }

    function hide_initial_elements(){
        hide_new_network_fields()
        hide_elements([networks_wrapper])
    }

    network_type.addEventListener("change", () => {
        handle_network_type_change()
    })

    // networks.addEventListener("change", () => {
    //     handle_networks_change()
    // })

    function hide_new_network_fields(){
        wrappers = [name_wrapper
        ]

        hide_elements(wrappers)
    }

    function hide_elements(elements){
        for (element in elements){
            elements[element].setAttribute('hidden', "hidden");
        }
    }

    function handle_network_type_change(){
        if (network_type.value == "dedicated"){
            show_elements([networks_wrapper])
            handle_networks_change()
        } else {
            hide_new_network_fields()
            hide_elements([networks_wrapper])
        }
    }

    function handle_networks_change(){
        if(networks.value == "-- New Dedicated Network"){
            show_new_network_fields()
        } else{
            hide_new_network_fields()
        }
    }

    function show_new_network_fields(){
        wrappers = [name_wrapper,networks_wrapper
        ]

        show_elements(wrappers)
    }

    function hide_new_network_fields(){
        wrappers = [name_wrapper
        ]

        hide_elements(wrappers)
    }

    cpu_choice.addEventListener("change", () => {
        cpu_cost.value = (cpu_choice.value * 1.15).toFixed(2)
        calculateBaseImageCost()
    })

    memory_choice.addEventListener("change", () => {
        memory_cost.value = (memory_choice.value * 0.48).toFixed(2)
        calculateBaseImageCost()
    })

    storage_choice.addEventListener("change", () => {
        storage_cost.value = (storage_choice.value * 0.10).toFixed(2)
        calculateBaseImageCost()
    })

    gpu_choice.addEventListener("change", () => {
        gpu_cost.value = gpu_choice.value == 'True' ? 6.07 : 0.00.toFixed(2)
        calculateBaseImageCost()
    })


    function calculateBaseImageCost(){
        base_cost = 31.31
        cost = base_cost + parseFloat(cpu_cost.value) + parseFloat(memory_cost.value) + parseFloat(storage_cost.value) + parseFloat(gpu_cost.value)
        total_cost.value = cost.toFixed(2)
    }
    
    function read_only_initial_elements(){
        elements = [cpu_cost,memory_cost,storage_cost,gpu_cost,total_cost]
        read_only_elements(elements)

    }

    function hide_elements(elements){
        for (element in elements){
            elements[element].setAttribute('hidden', "hidden");
        }
    }


    function show_elements(elements){
        for (element in elements){
            elements[element].removeAttribute('hidden', "hidden");
        }
    }



    function read_only_elements(elements){
        for (element in elements){
            elements[element].setAttribute('readonly',"readonly");
        }
    }
</script>
{% endblock %}
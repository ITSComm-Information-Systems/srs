{% extends 'base.html' %}

{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
<script type='text/javascript'>
    var groups = {{ groups_json|safe }};
    var network_choice_list = [
        {'key': 'private', 'label':'Shared Network (Private)'},
        {'key': 'web-access', 'label':'Shared Network (Web-Access)'},
        {'key': 'dedicated', 'label':'Dedicated Network'},
    ]
    var networklist = {{ network_json|safe }};
    var imagelist = {{ image_json|safe }};
    var eventBus = new Vue();
</script>


<h1>MiDesktop New Order Form</h1>

<div class="container">
    <form method="POST">
        {% csrf_token %}

        <div id="div_formbody">
            <div id="group">
                <h6>McCommunity Admin Group:</h6>
                    <select class="form-control" name="admin_group" id="id_admin_group" v-model="selectedGroup" @change="handleGroupChange">
                        <option v-for="group in groups" :value="group.name" :key="group.id">[[group.name]]</option>
                    </select>
            </div>
            <h6>{{form.shortcode.label_tag}}{{form.shortcode}}</h6>
            <h2>Order New Pool</h2>
            <h6>{{form.pool_name.label_tag}}{{form.pool_name}}</h6>
            <h6>{{form.pool_type.label_tag}}{{form.pool_type}}</h6>
            <h2>Connection Options</h2>
            <h6>{{form.auto_logout.label_tag}}{{form.auto_logout}}</h6>
            <h6>{{form.ad_container.label_tag}}{{form.ad_container}}</h6>
            <h6>{{form.ad_groups.label_tag}}{{form.ad_groups}}</h6>
            <div id="base_image"> <h6>{{form.base_image.label_tag}}
                <select class="form-control" name="base_image" id="id_base_image" v-model="selectedBaseImage">
                    <option v-for="image in filteredImages" :value="image.id" :key="image.id">[[image.name]] </option>
                </select></h6></div>
            <div>
            
            <div id="new-image-wrapper" v-show="visible">
                {{ form.image_form }}
                {{ form.calculator_form }}
            </div>

            <h6>{{form.pool_quantity.label_tag}}<input type="number" name="pool_quantity" class="form-control" id="id_pool_quantity" v-model="poolQuantity"/></h6>
            <h6>{{form.pool_total.label_tag}}<input type="text" name="pool_total" readonly="true" class="form-control" id="id_pool_total" :value="poolTotal"></h6>
            
            <div id="network_type" v-show="visible">
                <h6>Will you be using a shared network or a dedicated network?..
                    <select class="form-control" name="network_type" id="id_network_type" v-model="selectedNetworkType">
                        <option v-for="network_type in network_choice_list" :value="network_type.label" :key="network_type.key">[[network_type.label]] </option>
                    </select>
                </h6>
            </div>
            <div id="network" v-show="visible">
                <h6>Networks:
                    <select class="form-control" name="network" id="id_network" v-model="selectedNetwork">
                        <option v-for="network in filteredNetworks" :value="network.id" :key="network.id">[[network.name]] </option>
                    </select>
                </h6>
            </div>
        
            <div id="networks-wrapper" v-show="visible">
                {{ form.network_form }}
            </div>
            
            <h2>Service Level Expectations</h2>
            <hr/>
            <a href="https://its.umich.edu/computing/computers-software/midesktop" target="_blank">Click here for Service Level Expectations</a>
            <br/>{{ form.sla }} <span style="color:red; font-size:12px;">*</span>I have read and acknowledge the Service Level Expectations
        </div>
        <button id="submit_btn" type="submit" class="btn btn-primary">Submit</button>
    </form>
</div>


<script src="/static/vue-components/vue-components.js"></script>
<script>
    const pool_quantity = document.getElementById("{{ form.pool_quantity.id_for_label }}");
    const pool_total = document.getElementById("{{ form.pool_total.id_for_label }}");

</script>

<script>
    const pool_quantity_handler = new Vue({
        el: '#id_pool_quantity',
        delimiters: ['[[', ']]'],
        data: {
            poolQuantity: 1,
        },
        mounted() {
            eventBus.$on('new-base-image-selected', this.handleBaseImageSelected);
        },
        watch: {
            poolQuantity: function (newVal) {
                eventBus.$emit('pool-quantity-changed', newVal);
                this.handleQuantityChange(newVal)
            }
        },

        methods: {
            handleQuantityChange(quantity){
                console.log('quant cange')
                if (parseInt(quantity) <1){
                    this.poolQuantity = 1
                }
            },
            handleBaseImageSelected(){
                console.log('pew')
            }
        }
    });

    const pool_total_handler = new Vue({
        el: '#id_pool_total',
        delimiters: ['[[', ']]'],
        data: {
            poolTotal: '0.00',
            quantity: 1,
            baseImageTotalCost: 0.00
        },
        mounted() {
            
            eventBus.$on('new-base-image-selected', this.handleBaseImageSelected);
            eventBus.$on('pool-quantity-changed', this.handlePoolQuantityChanged);
        },

        methods: {
            handlePoolQuantityChanged(newQuantity){
                
                this.quantity = parseInt(newQuantity)
                
                console.log(this.quantity)
                this.calculateTotal()
            },
            handleBaseImageSelected(selectedBaseImage){
                this.selectedBaseImageID = selectedBaseImage
                if (this.selectedBaseImageID != 999999999){
                    this.baseImage = imagelist.filter(image => image.id === this.selectedBaseImageID)
                    this.baseImageTotalCost = this.baseImage[0].total_cost
                    this.calculateTotal()
                }else{

                }
            },
            calculateTotal(){
                this.poolTotal = (this.quantity * this.baseImageTotalCost).toFixed(2)
            },
        }
    });

    const new_image_wrapper = new Vue({
        el: '#new-image-wrapper',
        delimiters: ['[[', ']]'],
        data: {
            visible: false,
        },
        mounted() {
            eventBus.$on('new-base-image-selected', this.handleBaseImageSelected);
        },

        methods: {
            handleBaseImageSelected(selectedBaseImage){
                this.selectedBaseImage = selectedBaseImage
                this.updateVisibility();

            },
            updateVisibility(){
                if(this.selectedBaseImage === 'new' || this.selectedBaseImage === 999999999){
                    this.visible = true
                } else {
                    this.visible = false
                }
            }
        }
    });

    const base_image = new Vue({
    el: '#base_image',
    delimiters: ['[[', ']]'],
    data: {
        selectedBaseImage: null,
        filteredImages: [], // Add a data property to store filtered networks
        groups: groups
    },
    mounted(){
        eventBus.$on('group-selected', this.handleGroupChange);
        this.updateFilteredImages();
    },
    methods:{
        handleGroupChange(selectedGroup) {
            // Update the selectedGroup value when the group selection changes
            this.selectedGroup = selectedGroup;
            this.selectedGroupID = this.getGroupIdByName(selectedGroup)
            this.updateFilteredImages();
        },
        updateFilteredImages() {
            if (!this.selectedGroup) {
                // If no group is selected, show all images
                this.filteredImages = [];
            } else {
                // Filter images based on the selected group's id
                this.filteredImages = imagelist.filter(image => image.owner === this.selectedGroupID);
            }

            this.filteredImages.push({
                'id': 999999999,
                "name": '-- New Base Image',
                "owner": 'None'
            })
        },
        getGroupIdByName(groupName) {
            const group = this.groups.find(group => group.name === groupName);
            return group ? group.id : null;
        }
    },
    watch: {
        selectedBaseImage: function (newVal) {
            eventBus.$emit('new-base-image-selected', newVal);
        }
    },
})
</script>
{% endblock %}
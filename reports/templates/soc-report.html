{% extends 'base.html'%}

{% block content %}
<h1>{{ title }}</h1>
<div>
    <strong>Report selection</strong>
    <a class="float-right" href="../soc">Edit your selection</a>
    <a class="float-right" id="edit-selection" href="../soc"><i class="fas fa-edit"></i></a>
</div>

<div>
    <div class="card border-dark">
        <div class="card-body card-grid">
            <div class="deptid">
                <strong>Grouping: </strong>{{ grouping }}
            </div>
            <div class="deptname">
                <strong>Unit/Group: </strong>{{ unit }}
            </div>
            <div class="billdate">
                <strong>Billing Date: </strong>{{ billing_period }}
            </div>
        </div>
    </div>
</div>

<hr class="style1">

{% if table %}
<div class="soc-buttons">
    <div class="expand-collapse">
        <button onclick="expandAll()" class="btn btn-link">Expand All</button>
        <button onclick="collapseAll()" class="btn btn-link">Collapse All</button>
    </div>
    <button onclick="exportTableToCSV('{% for name in unit%}{{name}}_{% endfor %}{{billing_period}}.csv')" class="btn btn-success float-right">Download Table To
        CSV File
    </button>
</div>

<table class ="table table-sm">
    <thead class = "thead-dark">
        <tr>
            <th>Expense Account</th>
            <th>Item Description</th>
            <th>Charge Codes</th>
            <th>Rate</th>
            <th>Billed Units</th>
            <th>Item Total</th>
            <th>Item Group Total</th>
            <th>Account Total</th>

        </tr>
    </thead>

    <tbody>
        {% for row in table.0.0 %}
        <tr class = "table-warning">
            <td><b>{{ row.0 }} ({{ row.1 }})
                    <input class = 'toggle1' type="checkbox" name="{{row.0}}" data-toggle="toggle">
                </b></td>

            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td><b>${{ row.3 }}</b></td>
        </tr>
    <tbody class = "{{row.0}}" id = "{{row.0}}" style = "display:none">
        {% for charge in row.2%}
        <tr class = "table-secondary">
            <td>{{ charge.0 }}
            <input class = 'toggle2' type="checkbox" name="{{charge.2}}" id="1" data-toggle="toggle2">
                
            </td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td>${{ charge.2}}</td>
            <td></td>
        </tr>
        <div>    
            {% for code in charge.1%}
                <tr class = "{{charge.2}}" style = "display: none">
                    <td></td>
                    <td>{{ code.0 }}</td>
                    <td>{{ code.1 }}</td>
                    <td>${{ code.2 }}</td>
                    <td>{{ code.3 }}</td>
                    <td>${{ code.4 }}</td>
                    <td></td>
                    <td></td>
                </tr>
            {% endfor %}   
        </div>
        {% endfor %}

        </tbody>
    {% endfor %}

    <tr>
        <td><b>Total ITCom Charges</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td><b>${{table.0.1}}</td>
    </tr>
    </tbody>

</table>
<p></p>
<p></p>

{% else %}
<div class="mt-2">
    <div class="alert alert-danger col-md-8" role="alert">
        <i class="fas fa-exclamation-triangle prv-msgs"></i>
        No charges for current selection
    </div>
</div>
{% endif%}


<script>
    function display_active(active) {
        var group = document.forms["Select"]["department_group"];
        var index = group.selectedIndex - 1;
        document.getElementById("display").innerHTML = active[index]

    }
</script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {

        $('[data-toggle="toggle"]').parents().next('.hide').toggle();
        $('[data-toggle="toggle2"]').parents().next('.hide').toggle();

        

        $('[data-toggle="toggle"]').change(function () {
            var name = this.name;
            
            
            var result_style = document.getElementsByClassName(name);
            for(var i=0; i<result_style.length; i++) {
                if (result_style[i].style.display == 'table-row-group') {
                    result_style[i].style.display = 'none';
                }
                else {
                    result_style[i].style.display = 'table-row-group';
                }
            }
        });



        $('[data-toggle="toggle2"]').change(function () {
            var name = this.name;


            var result_style = document.getElementsByClassName(name);
            for (var i = 0; i < result_style.length; i++) {
                if (result_style[i].style.display == 'table-row') {
                    result_style[i].style.display = 'none';
                }
                else {
                    result_style[i].style.display = 'table-row';
                }
            }
        });


    });

    
</script>
<script>


    function exportTableToCSV(filename) {
        var csv = [];
        var rows = document.querySelectorAll("table tr");

        for (var i = 0; i < rows.length; i++) {
            var row = [], cols = rows[i].querySelectorAll("td, th");

            for (var j = 0; j < cols.length; j++)
                row.push(cols[j].innerText);

            csv.push(row.join(","));
        }

        // Download CSV file
        downloadCSV(csv.join("\n"), filename);
    }

    function downloadCSV(csv, filename) {
        var csvFile;
        var downloadLink;

        // CSV file
        csvFile = new Blob([csv], { type: "text/csv" });

        // Download link
        downloadLink = document.createElement("a");

        // File name
        downloadLink.download = filename;

        // Create a link to the file
        downloadLink.href = window.URL.createObjectURL(csvFile);

        // Hide download link
        downloadLink.style.display = "none";

        // Add the link to DOM
        document.body.appendChild(downloadLink);

        // Click download link
        downloadLink.click();
    }

    function expandAll() {
        var toggle = document.getElementsByClassName('toggle1');
        for(var i = 0; i <toggle.length;i++) {
            var name = toggle[i].name;
            toggle[i].checked = true;
            var result_style = document.getElementsByClassName(name);
            for(var j=0; j<result_style.length; j++) {
                result_style[j].style.display = 'table-row-group';
            }
        }
        var toggle = document.getElementsByClassName('toggle2');
        for(var i = 0; i <toggle.length;i++) {
            var name = toggle[i].name;
            toggle[i].checked = true;
            var result_style = document.getElementsByClassName(name);
            for(var j=0; j<result_style.length; j++) {
                result_style[j].style.display = 'table-row';
            }
        }
    }

    function collapseAll() {
        var toggle = document.getElementsByClassName('toggle1');
        for(var i = 0; i <toggle.length;i++) {
            var name = toggle[i].name;
            toggle[i].checked = false;
            var result_style = document.getElementsByClassName(name);
            for(var j=0; j<result_style.length; j++) {
                result_style[j].style.display = 'none';
            }
        }
        var toggle = document.getElementsByClassName('toggle2');
        for(var i = 0; i <toggle.length;i++) {
            var name = toggle[i].name;
            toggle[i].checked = false;
            var result_style = document.getElementsByClassName(name);
            for(var j=0; j<result_style.length; j++) {
                result_style[j].style.display = 'none';
            }
        }
    }
</script>
{% endblock %}